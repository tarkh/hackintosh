# Huananzhi F8D
**([english version](https://github.com/tarkh/hackintosh/tree/macOS-11-(Big-Sur)/Huananzhi-F8D))**

## ![#f03c15](https://via.placeholder.com/15/f03c15/000000?text=+) `Версия для macOS 11 (Big Sur)`
*Данная версия должна работать с операционными системами macOS начиная с **10.14 (Mojave)** и заканчивая **macOS 11 (Big Sur)**, тем не менее если у вас возникли проблемы с запуском **macOS < 11 версии**, то можете попробовать более раннюю сборку загрузчика из соответствующего бранча `macOS 10.14 (Mojave)` в данном репозитории.*

##
* [Вводная информация](#intro)
* [Настройка BIOS](#biossetup)
* [Запуск macOS](#runmac)
* [Прошивка BIOS](#wbios)
* [Анлок и андервольтинг](#unlock)
* [Для пользователей Windows](#windows)
* [Для пользователей Linux](#linux)
* [Убираем из системы USB-накопитель](#removeusb)
* [Я pro, не хочу читать многабукв](#impro)
* [Эпилог](#end)

<a name="intro"></a>
## Вводная информация

В данном репозитории представлена информация по установке **macOS** на систему со следующими техническими характеристиками:

* Материнская плата: Huananzhi F8D
* Процессор: x2 E5-2678v3

В качестве EFI-загрузчика будет использоваться **OpenCore (0.7.6)**, поэтому перед началом работы крайне рекомендуется ознакомиться с данным загрузчиком и его функционалом [тут (OpenCore Guide)](https://dortania.github.io/OpenCore-Install-Guide/). Помимо базовой настройки OpenCore будет описан метод по разблокировке турбо-режима на всех ядрах процессора и его андервольтингу. Пользователи **Windows** также могут использовать EFI-загрузчик OpenCore для анлока турбо-буста и андервольтинга, о чем будет сказано в отдельной главе [Для пользователей Windows](#windows).

<a name="biossetup"></a>
## Настройка BIOS

Если вы не собираетесь перепрошивать биос, тогда вам необходимо внести определенные изменения в настройки стокового биоса. Биос для прошивки из данного репозитория уже содержит необходимые настройки по умолчанию для корректного запуска macOS.

Для начала зайдите в биос, сбросьте все настройки на дефолтные и сохранитесь с перезагрузкой, затем измените следующие параметры:

* `Advanced > Trusted Computing > Security Device Support` **Disabled**
* `Advanced > ACPI Settings > Enable ACPI Auto Configuration` **Enabled**
* `Advanced > NCT5532D SSIO Configuration > Serial Port 1 Configuration > Serial Port` **Disabled**
* `Advanced > Smart Fan function setting` надо настроить в зависимости от вашей системы охлаждения и процессоров. В моем случае в корпусе с вентиляторами на вдув и выдув и башнями A500 на обоих процессорах настройки выставлены следующим образом (тихо и температура в полной нагрузке не превышает 65 градусов):
  * `Smart Fan Temperature 1` **30**
  * `Smart Fan Temperature 2` **42**
  * `Smart Fan Temperature 3` **55**
  * `Smart Fan Temperature 4` **67**
  * `Smart Fan Critical Temperature` **67**
  * `Smart Fan PWM 1` **25**
  * `Smart Fan PWM 2` **51**
  * `Smart Fan PWM 3` **127**
  * `Smart Fan PWM 4` **255**
* `Advanced > Serial Port Console Redirection > Console Redirection` **Disabled**
* `Advanced > PCI Subsystem Settings > Above 4G Decoding` **Enabled**
* `Advanced > Network Stack Configuration > LAN Wake up Control` **Disabled**
* `Advanced > CSM Configuration > CSM Support` **Disabled**. Чтобы отключить данную опцию, сначала необходимо перевести Video из режима `Legacy` в режим `UEFI`, сохранить настройки биос и перезагрузиться. Только после этого станет доступна возможность выставить `CSM Support` в положение **Disabled**. При этом в зависимости от видео-карты при выставлении параметра Video из режима `Legacy` в режим `UEFI` необходимо обязательно поставить параметр `Advanced > PCI Subsystem Settings > Above 4G Decoding` в позицию **Enabled**, иначе после перезагрузки может пропасть видео и биос придется сбрасывать путем извлечения батарейки.
* `Advanced > USB Configuration > EHCI Hand-Off` **Enabled**
* `IntelRCSetup > Processor Configuration > MSR Lock Control` **Disable**
* `IntelRCSetup > Advanced Power Management Configuration > CPU C State Control > Package C State limit` **C2 state**
* `IntelRCSetup > Advanced Power Management Configuration > CPU C State Control > CPU C3 report` **Enable**
* `IntelRCSetup > Advanced Power Management Configuration > CPU C State Control > CPU C6 report` **Disable**
* `Security > Secure Boot menu > Secure Boot` **Disabled**

<a name="runmac"></a>
## Запуск macOS

Для запуска macOS нам понадобится директория `./EFI`, которую необходимо целиком скопировать в корень USB-накопителя, предварительно отформатировав его в **fat32**.

> Если у вас нет установленной ранее macOS на внутреннем диске, тогда вам нужно создать установочный флеш-накопитель по [официальной инструкции OpenCore](https://dortania.github.io/OpenCore-Install-Guide/installer-guide/). Когда вы запишите установочный флеш-накопитель и дойдете до [этого пункта](https://dortania.github.io/OpenCore-Install-Guide/installer-guide/mac-install.html#setting-up-opencore-s-efi-environment), скопируйте в корень смонтированного EFI-раздела директорию `./EFI` из данного репозитория.

Директория EFI содержит преднастроенный для данной конкретной системы загрузчик OpenCore. Пропатчены и скомпилированы все необходимые ACPI таблицы, добавлены нужные kext'ы, поддержка 24 ядер и 48 потоков, настроен `EFI/OC/config.plist`.

Тем не менее, перед запуском необходимо внести некоторые обязательные изменения в директорию EFI и `EFI/OC/config.plist`. Во избежании непредвиденных ошибок файлы типа `*.plist` открывайте в специализированном plist-редакторе! Итак, что нужно сделать:

* Сгенерировать и добавить свои уникальные серийные номера для модели **iMac15,1**. Вам понадобится утилита [GenSMBIOS](https://github.com/corpnewt/GenSMBIOS). Полученные UUID и серийники нужно заменить в файле `EFI/OC/config.plist` в следующих ключах:
  * `PlatformInfo > Generic > MLB` ставим сгенерированное значение `Board Serial`.
  * `PlatformInfo > Generic > SystemSerialNumber` ставим сгенерированное значение `Serial`.
  * `PlatformInfo > Generic > SystemUUID` ставим сгенерированное значение `SmUUID`.
* Если ваш процессор **отличается** от E5 2678v3, вам будет необходимо перенастроить `VoodooTSCSync.kext`, поскольку он настроен на 48 потоков. Можете [воспользоваться конфигуратором](https://www.insanelymac.com/forum/files/file/744-voodootscsync-configurator/), который поможет сгенерировать необходимый файл. Либо можно попробовать поправить количество потоков вручную в конфиге kext'а `EFI/OC/Kexts/VoodooTSCSync.kext/Contents/Info.plist` в ключе `IOKitPersonalities > VoodooTSCSync > IOPropertyMatch > IOCPUNumber` необходимо поставить суммарное число потоков ваших процессоров начиная с 0. Т.е. для двух E5 2678v3 (12 x 2 x 2) сейчас стоит значение 47.
* Также, если процессоры отличаются, в последствии уже из macOS не будет лишним переделать `CPUFriendDataProvider.kext`, т.к он также сделать под конкретный процессор. Подробная информация [доступна тут](https://dortania.github.io/OpenCore-Post-Install/universal/pm.html#using-cpu-friend).
* USB-порты настроены под конкретную модель материнской платы, настройки находятся в `EFI/OC/Kexts/USB-Map.kext/Contents/info.plist`. Поскольку macOS ограничивает количество портов до 15 на 1 контроллер, то пришлось оставить фронтальный порт USB 3 и 2 задних `нижних` порта USB 3 только в режиме USB 3 без поддержки USB 2. Все остальные обычные USB 2 порты работают. Также 2 задних `верхних` USB 3 работают в двух режимах USB 3/USB 2. Помимо этого я располагаю дискретной PCIe WiFi картой c Bluetooth, работающей в нативном режиме. Bluetooth устройства в macOS определяются как USB устройства и занимают 1 порт, но должны быть отмечены специальным образом для корректной работы. В представленном `USB-Map.kext` такой порт прописан относительно моей конфигурации железа. В вашем случае Bluetooth порт может быть другим или устройство Bluetooth может вовсе отсутствовать, поэтому рекомендую настроить `USB-Map.kext/Contents/info.plist` конкретно под вашу конфигурацию. Детальная инструкция по конфигурированию USB-портов [находится тут](https://dortania.github.io/OpenCore-Post-Install/usb/system-preparation.html).
* Если вы идете в хронологическом порядке по данной инструкции и еще не перепрошили BIOS для возможности разблокировки турбо-буста и андервольтинга, то убедитесь, что предустановленный efi-модуль `v3x2_80-50-50_39_vcc1.8.efi` деактивирован. Для этого в `EFI/OC/config.plist` в `UEFI > Drivers` находите запись с параметром `path`: `v3x2_80-50-50_39_vcc1.8.efi` и смотрите, чтобы значение поля `Enabled` было `false`.

Сохраните файл конфигурации, перезагрузите компьютер, зайдите в BIOS и выберите загрузку с UEFI-раздела вашего флеш-накопителя. Если все было сделано правильно, вы увидите загрузочное меню OpenCore, где сможете выбрать внутренний накопитель с уже установленной macOS или установщик macOS в случае свежей установки.

<a name="wbios"></a>
## Прошивка BIOS

В директории `./Bios` вы найдете 2 файла биос и 2 соответствующих bat-скрипта для прошивки из `AFUDOS` со специального загрузочного флеш-накопителя. Сделать такой накопитель вы можете при помощи программы `Rufus` в Windows, предварительно полностью очистив накопитель и удалив все разделы. Более детальную информацию можно найти в `Google/Yandex`.

В данном методе используется биос [HNX99F8D_200624_kot_v002](https://github.com/Koshak1013/HuananzhiX99_BIOS_mods/tree/master/Huananzhi%20X99-F8D/2020-06-24) из замечательного репозитория от [Koshak1013](https://github.com/Koshak1013). Данный биос содержит ряд фиксов, обновлений по микрокодам, BCLK 100.00MHz, доступ к настройкам таймингов памяти и разлоченные МЕ-регионы, чтобы впоследствии можно было шить без программатора. **Ребята делают большую работу, а репозиторий постоянно пополняется новыми биосами к различным материнским платам из Поднебесной, поэтому не стесняемся переходить в их репозиторий и делать донат!**

Итак, в директории `./Bios` имеются следующие биосы:

* **f8dKS.bin**, где:
  * **K** - оригинал биоса от [Koshak1013](https://github.com/Koshak1013) (`HNX99F8D_200624_kot_v002`).
  * **S** - вшиты специальные настройки для корректной работы в macOS (из п. [Настройка BIOS](#biossetup)).
* **f8dKSM.bin**, где:
  * **K** и **S** из предыдущего пункта.
  * **M** - удален микрокод `6F 06F2` для возможности последующей разблокировки турбо-буста посредством efi-модулей.

Если в вашей материнской плате стоит стоковый биос, то в нем залочены МЕ-регионы. Тем не менее есть 2 способа прошить модифицированный биос...

> **Как обычно все операции с прошивкой биоса вы выполняете на свой страх и риск, с полным пониманием, что просто необходимо иметь программатор для возможности восстановить "окирпичевшуюся" плату.**

#### Способ 1 (правильный)

Используйте программатор `CH341A` с прищепкой. В таком случае нет необходимости выпаивать биос, достаточно правильно надеть прищепку, вынуть батарейку из материнской платы, а БП оставить подключенным к сети с включенной защелкой. Можно найти массу материалов по этому вопросу в `Google/Yandex` по прошивки со второго компьютера под ОС Windows.

Я бы хотел описать альтернативный способ по прошивке биоса через программатор из под macOS или Linux. Для этого нам потребуется комманд-лайн утилита [flashrom](https://flashrom.org/Flashrom). На мой взгляд работать с ней намного проще, чем через GUI приложение в Windows. На macOS данную утилиту можно [установить через Homebrew](https://brewinstall.org/install-flashrom-on-mac-with-brew/). После установки в Терминале становится доступна команда `flashrom` ([почитать man](https://linux.die.net/man/8/flashrom)). Правильно подключаем программатор и делаем дамп текущего биоса:

`sudo flashrom --programmer ch341a_spi -r backup.bin`

Затем прошиваем наш модифицированный биос. Если вы хотите делать разблокировку турбо-буста, шьем `f8dKSM.bin`, если нет, тогда `f8dKS.bin`:

`sudo flashrom --programmer ch341a_spi -w f8dKSM.bin`

Flashrom автоматически сделает дамп в память, очистит биос, прошьет новый, считает его и сверит с дампом. В общем все достаточно просто.

#### Способ 2

Не смотря на то, что стоковый биос имеет лок на МЕ-регионах, прошить поверх модифицированный все же можно, используя программу `Afudos` с загрузочного USB-накопителя. Биос прошивается, но не полностью, оставив залоченные МЕ-регионы. Способ такой прошивки проверялся мной лично, разблокировка турбо-буста и меню таймингов памяти работают. Тем не менее **крайне рекомендую обзавестись программатором и прошить 1 раз модифицированный биос правильно, все последующие прошивания можно делать уже без программатора, так как все будет разлочено**.

#### Пост-прошивка

После прошивки биоса из данного репозитория нет необходимости вытаскивать батарейку из материнской платы и сбрасывать настройки в дефолт - все уже настроено для корректной работы macOS. По завершении прошивки выключите компьютер, подождите 10 секунд и включайте обратно. Можно грузиться в macOS.

<a name="unlock"></a>
## Анлок и андервольтинг

Разблокировку турбо-буста на всех ядрах и андервольтинг будем делать посредством efi-модулей от пользователя [MOF с форума AnandTech](https://forums.anandtech.com/threads/what-controls-turbo-core-in-xeons.2496647/page-112#post-39875881). Данный способ достаточно прост и нет необходимости перепрошивать биос каждый раз, чтобы внести корректировки. Из минусов:
* Необходим EFI-загрузчик (в нашем случае это не минус, так как мы все равно используем OpenCore).
* Efi-модули содержат среднюю сетку значений по андервольтингу, совсем кастомные значения можно установить только собрав свой Efi-модуль, либо делая прошивку модуля напрямую в биос.

Если вам нужна простота и гибкость, продолжайте чтение. Если вы хотите хардкорить настройки максимально точно под ваши процессоры, выжимая каждый милливольт до предела, переходите в репозиторий от [Koshak1013](https://github.com/Koshak1013), там подробно описан способ подбора предельных значений, сборки драйвера и прошивки оного непосредственно в биос.

Итак, чтобы сделать анлок и андервольтинг процессора, необходимо загрузить в биос efi-драйвер, отвечающий за это. Как я писал выше, в данном репозитории представлены драйверы от `MOF`, поскольку у меня лично они показали наилучший результат. В директории `./mmof` вы найдете множество файлов с разными записанными в них настройками, значения которых отображены в самих названиях. Например, в моем случае в OpenCore по дефолту уже предустановлен драйвер `v3x2_80-50-50_39_vcc1.8.efi`, что означает:

* -80mV ядра.
* -50mV кэш.
* -50mV системный агент.
* 1.8V vccin.
* Powercut + ucode39.

Для ваших конкретных процессоров значения могут отличаться, так как кристаллы в процессорах одной и той же модели могут отличаться своими свойствами. Кремниевая лотерея, так сказать.

Установка необходимого драйвера в EFI-загрузчик OpenCore происходит в 2 шага:

* Нужный efi-модуль из директории `./mmof` необходимо скопировать на USB-накопитель c OpenCore в /EFI/OC/Drivers/
* Открыть конфиг `EFI/OC/config.plist` в специализированном `*.plist` редакторе и перейти к ключу `UEFI > Drivers`, там найти запись с параметром `path`: `v3x2_80-50-50_39_vcc1.8.efi` и поменять значение поля `Enabled` с `false` на `true`.

Сохраняем конфиг и **выключаем** (не перезагружаем) компьютер. Через 10 секунд включаем обратно и в биосе выбираем загрузку с UEFI раздела USB-накопителя.

Сразу после этого мы должны увидеть заставку American Megatrends, под которой должен появится примерно следующий текст:

```
Package 00: Core x33: UnCore: x30 Done!
Package 01: Core x33: UnCore: x30 Done!
uCode ver 0x39: *************************************************
Done!
```

Это будет означать, что наш efi-модуль успешно загружен. Далее ваша задача правильно протестировать работу процессора в нагрузках разного типа. Подробнее об этом читайте в репозитории от [Koshak1013](https://github.com/Koshak1013).

<a name="windows"></a>
## Для пользователей Windows

Данный репозиторий в первую очередь предназначен для адептов Хакинтоша, но используемый нами EFI-загрузчик OpenCore настроен и полностью готов для работы с ОС Windows, как в режиме дуал-бута вместе с macOS, так и без неё.

>**Основное требование к Windows - операционная система должна быть установлена только в UEFI-режиме!**

Для запуска нам надо прошить биос (глава [Прошивка BIOS](#wbios)), сделать USB-накопитель (начало главы [Запуск macOS](#runmac)) и положить необходимый efi-драйвер в OpenCore (глава [Анлок и андервольтинг](#unlock)).

Выключаем компьютер, ждем 10 секунд, запускаем и в биосе выбираем UEFI-раздел нашего USB-накопителя. Должно появиться загрузочное меню OpenCore, где вы сможете выбрать необходимую ОС для загрузки. Если ничего не выбирать, то через 5 секунд OpenCore загрузит первую в списке ОС автоматически. Более тонкие настройки меню загрузчика можно сделать позже, изучив [возможности OpenCore](https://dortania.github.io/OpenCore-Install-Guide/).

<a name="linux"></a>
## Для пользователей Linux

Для пользователей Linux действительно всё, сказанное в предыдущем разделе [Для пользователей Windows](#windows).

<a name="removeusb"></a>
## Убираем из системы USB-накопитель

После того, как идеальный efi-драйвер найден и вы **преисполнились какнада**, мы готовы к консервации загрузчика, чтобы избавиться от необходимости иметь загрузочную флешку в USB-разъеме компьютера. Для этого нам необходимо смонтировать EFI-раздел на внутреннем диске и перенести в его корень директорию EFI из корня нашего USB-накопителя. Если мы используем macOS, желательно смонтировать EFI-раздел на том же самом носителе, где расположена ОС. Это верно и для любых других операционных систем. В мульте-бут достаточно расположить OpenCore на какой-то один из носителей. Главное не забыть назначить этот носитель первым в очереди на загрузку в биосе.

Как монтировать EFI-разделы в разных операционных системах можно найти в `Google/Yandex`. Вот хорошее и достаточно короткое руководство для [macOS/Linux/Windows](https://noobsplanet.com/index.php?threads/how-to-mount-efi-partition-from-windows-linux-or-mac.56/).

<a name="impro"></a>
## Я pro, не хочу читать многабукв

Ок, тогда все просто:

* Шьем биос из `./Bios`. **f8dKS.bin** без анлока-турбобуста но с вшитыми настройками для macOS (Linux и Windows при этом тоже работают). **f8dKSM.bin** то же самое + удален микрокод `6F 06F2`.
* Форматируем флешку в **fat32**, скидываем в корень директорию `./EFI`
* В `EFI/OC/config.plist` прописываем свои сгенерированные серийники для **iMac15,1**. Если macOS не нужен, можно пропустить.
* Закидываем нужный efi-модуль из `./mmof` в `EFI/OC/Drivers` и правим имя файла в `EFI/OC/config.plist`, в ключе `UEFI > Drivers`.
* Сохраняем, выключаем, ждем, включаем, бутимся с флешки - win-win.

<a name="end"></a>
## Эпилог

Касательно macOS, у меня получилась полностью рабочая стабильная система. PowerManagement работает хорошо, даже без анлока турбо-буста система выдает хорошие результаты в бенчмарках. В среднем на 10-15% меньше, чем с анлоком, т.е. разница не колоссальна.

>**НЕ работает сон, но эта проблема происходит от самого ядра macOS, поскольку в современных компьютерах от Apple отсутствуют двухсокетные решения. Возможно, кто то решит эту задачу в рамках патчей для OpenCore. Если узнаете о решении первыми - пожалуйста, сообщите.**

Буду рад фидбэку с целью улучшить данную конфигурацию. Меня можно найти в telegram:
* [@tarkhx](https://t.me/tarkhx)
* [Телеграм-группа по LGA2011 и XEON](https://t.me/Chinese_lga2011_3_x99)
